{% extends "base.html" %}

{% block title %}Data Scraper - OpenWall{% endblock %}

{% block extra_css %}
<style>
    .scraper-log {
        max-height: 500px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .scraper-action {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 8px;
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-left: 4px solid var(--openwall-primary);
        transition: transform 0.2s ease;
    }
    
    .scraper-action:hover {
        transform: translateY(-2px);
    }
    
    .scraper-action.privacy-leak {
        background-color: rgba(234, 67, 53, 0.1);
        border: 2px solid var(--openwall-danger);
        position: relative;
        overflow: hidden;
        padding-right: 130px; /* Make room for the thief icon */
        border-left: 4px solid var(--openwall-danger);
    }
    
    .scraper-action.privacy-leak::after {
        content: "";
        position: absolute;
        top: 40px; /* Position below the header */
        right: 10px;
        width: 120px;
        height: 80px;
        background-image: url("{{ url_for('static', filename='img/data-thief.svg') }}");
        background-repeat: no-repeat;
        background-size: contain;
        opacity: 0.95;
        z-index: 1; /* Ensure it's below the header text */
        filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3)); /* Add shadow for depth */
    }
    
    .scraper-timestamp {
        color: #6c757d;
        font-size: 0.8em;
        margin-bottom: 5px;
    }
    
    .scraper-url {
        font-family: monospace;
        background-color: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        color: var(--openwall-primary);
    }
    
    .scraper-status {
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
    }
    
    .scraper-status.complete {
        color: white;
        background-color: var(--openwall-secondary);
    }
    
    .scraper-status.error {
        color: white;
        background-color: var(--openwall-danger);
    }
    
    .scraper-status.in-progress {
        color: white;
        background-color: var(--openwall-primary);
    }
    
    .privacy-leak-header {
        position: relative;
        z-index: 2; /* Ensure text appears above the thief icon */
        background-color: rgba(255, 235, 235, 0.8); /* Semi-transparent background */
        padding: 5px 10px;
        border-radius: 4px;
        border-left: 4px solid var(--openwall-danger);
        margin-top: 5px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .privacy-leak-header h4 {
        color: var(--openwall-danger);
        margin: 0;
        font-weight: bold;
        display: flex;
        align-items: center;
        font-size: 1.1rem;
        text-shadow: 0 1px 1px rgba(255,255,255,0.8);
    }
    
    .privacy-leak-header h4::before {
        content: "⚠️";
        margin-right: 8px;
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card card-openwall mb-4">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-robot me-2"></i>Data Scraper Simulation</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-openwall mb-4">
                    <h5 class="text-openwall-primary"><i class="bi bi-info-circle-fill me-2"></i>What is this?</h5>
                    <p>This tool simulates a third-party application or scraper that accesses the API endpoints of this application.</p>
                    <p class="mb-0">It demonstrates how insecure API endpoints can lead to privacy leaks, even when the user interface respects privacy settings.</p>
                </div>
                
                <div class="alert alert-warning">
                    <h5 class="mb-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>Educational Purpose Only</h5>
                    <p class="mb-0">This feature is designed to demonstrate privacy vulnerabilities and should only be used for educational purposes.</p>
                </div>
                
                <div class="d-flex justify-content-between mb-4">
                    <button id="start-scraper" class="btn btn-danger" {% if scraper_running %}disabled{% endif %}>
                        <i class="bi bi-play-fill me-2"></i>Start Data Scraper
                    </button>
                    <button id="stop-scraper" class="btn btn-secondary" {% if not scraper_running %}disabled{% endif %}>
                        <i class="bi bi-stop-fill me-2"></i>Stop Scraper
                    </button>
                </div>
                
                <h5 class="text-openwall-primary mb-3"><i class="bi bi-activity me-2"></i>Scraper Activity Log</h5>
                <div id="scraper-status" class="alert {% if scraper_running %}alert-warning{% else %}alert-info{% endif %} mb-3">
                    {% if scraper_running %}
                        <i class="bi bi-arrow-repeat me-2"></i><strong>Scraper is currently running...</strong>
                    {% else %}
                        <i class="bi bi-stop-circle me-2"></i><strong>Scraper is not running</strong>
                    {% endif %}
                </div>
                
                <div id="scraper-log" class="scraper-log">
                    {% if scraper_results %}
                        {% for result in scraper_results %}
                            <div class="scraper-action {% if result.privacy_leak or 'private' in result.data_collected|lower or 'leak' in result.data_collected|lower %}privacy-leak{% endif %}">
                                {% if result.privacy_leak or 'private' in result.data_collected|lower or 'leak' in result.data_collected|lower %}
                                <div class="privacy-leak-header">
                                    <h4>PRIVACY LEAK DETECTED</h4>
                                </div>
                                {% endif %}
                                <div class="scraper-timestamp">{{ result.timestamp }}</div>
                                <div><strong>Action:</strong> {{ result.action }}</div>
                                {% if result.url %}
                                    <div><strong>URL:</strong> <span class="scraper-url">{{ result.url }}</span></div>
                                {% endif %}
                                <div>
                                    <strong>Status:</strong> 
                                    <span class="scraper-status {% if result.status == 'Complete' %}complete{% elif result.status == 'Error' %}error{% else %}in-progress{% endif %}">
                                        {{ result.status }}
                                    </span>
                                </div>
                                {% if result.leak_type %}
                                    <div class="text-danger"><strong>Privacy Issue:</strong> {{ result.leak_type }}</div>
                                {% endif %}
                                {% if result.data_collected %}
                                    <div><strong>Data Collected:</strong> {{ result.data_collected }}</div>
                                {% endif %}
                                {% if result.leaked_content %}
                                    <div class="mt-2 p-2 bg-danger text-white rounded">
                                        <strong>Leaked Content:</strong> {{ result.leaked_content }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-3">
                            No scraper activity yet. Click "Start Data Scraper" to begin.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const startButton = document.getElementById('start-scraper');
        const stopButton = document.getElementById('stop-scraper');
        const scraperStatus = document.getElementById('scraper-status');
        const scraperLog = document.getElementById('scraper-log');
        
        // Function to update the UI based on scraper status
        function updateScraperUI(running, results) {
            startButton.disabled = running;
            stopButton.disabled = !running;
            
            if (running) {
                scraperStatus.className = 'alert alert-warning mb-3';
                scraperStatus.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i><strong>Scraper is currently running...</strong>';
            } else {
                scraperStatus.className = 'alert alert-info mb-3';
                scraperStatus.innerHTML = '<i class="bi bi-stop-circle me-2"></i><strong>Scraper is not running</strong>';
            }
            
            // Update the log with the latest results
            if (results && results.length > 0) {
                let logHtml = '';
                
                results.forEach(result => {
                    // Improved privacy leak detection
                    const isPrivacyLeak = result.privacy_leak || (
                        (result.data_collected && (
                            result.data_collected.toLowerCase().includes('private') || 
                            result.data_collected.toLowerCase().includes('leak') ||
                            result.data_collected.toLowerCase().includes('deleted') ||
                            result.data_collected.toLowerCase().includes('should be inaccessible') ||
                            result.data_collected.toLowerCase().includes('emails')
                        )) || 
                        (result.action && result.action.toLowerCase().includes('private')) ||
                        (result.url && (
                            result.url.includes('/api/users') || 
                            result.url.includes('/api/posts/all')
                        ))
                    );
                    
                    logHtml += `
                        <div class="scraper-action ${isPrivacyLeak ? 'privacy-leak' : ''}">
                            ${isPrivacyLeak ? `
                                <div class="privacy-leak-header">
                                    <h4>PRIVACY LEAK DETECTED</h4>
                                </div>
                            ` : ''}
                            <div class="scraper-timestamp">${result.timestamp}</div>
                            <div><strong>Action:</strong> ${result.action}</div>
                            ${result.url ? `<div><strong>URL:</strong> <span class="scraper-url">${result.url}</span></div>` : ''}
                            <div>
                                <strong>Status:</strong> 
                                <span class="scraper-status ${
                                    result.status === 'Complete' ? 'complete' : 
                                    result.status === 'Error' ? 'error' : 'in-progress'
                                }">
                                    ${result.status}
                                </span>
                            </div>
                            ${result.leak_type ? `<div class="text-danger"><strong>Privacy Issue:</strong> ${result.leak_type}</div>` : ''}
                            ${result.data_collected ? `<div><strong>Data Collected:</strong> ${result.data_collected}</div>` : ''}
                            ${result.leaked_content ? `<div class="mt-2 p-2 bg-danger text-white rounded"><strong>Leaked Content:</strong> ${result.leaked_content}</div>` : ''}
                        </div>
                    `;
                });
                
                scraperLog.innerHTML = logHtml;
                
                // Scroll to the bottom of the log
                scraperLog.scrollTop = scraperLog.scrollHeight;
            }
        }
        
        // Function to poll for scraper status
        function pollScraperStatus() {
            fetch('/scraper/status')
                .then(response => response.json())
                .then(data => {
                    updateScraperUI(data.running, data.results);
                    
                    // Continue polling if the scraper is running
                    if (data.running) {
                        setTimeout(pollScraperStatus, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error polling scraper status:', error);
                    setTimeout(pollScraperStatus, 5000);  // Retry after 5 seconds on error
                });
        }
        
        // Start the scraper
        startButton.addEventListener('click', function() {
            fetch('/scraper/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateScraperUI(true, []);
                    pollScraperStatus();
                } else {
                    alert('Failed to start scraper: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error starting scraper:', error);
                alert('An error occurred while starting the scraper.');
            });
        });
        
        // Stop the scraper
        stopButton.addEventListener('click', function() {
            fetch('/scraper/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateScraperUI(false, []);
                    pollScraperStatus();
                } else {
                    alert('Failed to stop scraper: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error stopping scraper:', error);
                alert('An error occurred while stopping the scraper.');
            });
        });
        
        // Initial poll for status
        pollScraperStatus();
    });
</script>
{% endblock %}